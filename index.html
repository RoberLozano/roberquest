<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8'>
  <meta http-equiv='X-UA-Compatible' content='IE=edge'>

  <title>Pruebas de RoberQuest</title>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.9/css/bootstrap-select.css" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css"
    integrity="sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ" crossorigin="anonymous">
  <link rel="stylesheet" href="bubbler.css">
  <!-- ESTILOS PROPIOS -->
  <style type="text/css">
    @font-face {
      font-family: "Friedolin";
      src: url("Friedolin.ttf");
    }

    @font-face {
      font-family: "MediciText";
      src: url("MediciText.otf");
    }

    @font-face {
      font-family: "Old Europe";
      src: url("Old Europe.ttf");
    }

    h5 {
      font-family: Friedolin;
      font-size: 300%;
    }

    h2 {
      font-family: MediciText;
    }

    .number-input {
      width: 60px;
    }

    .gold {
      background: radial-gradient(ellipse farthest-corner at right bottom, #FEDB37 0%, #FDB931 8%, #9f7928 30%, #8A6E2F 40%, transparent 80%),
        radial-gradient(ellipse farthest-corner at left top, #FFFFFF 0%, #FFFFAC 8%, #D1B464 25%, #5d4a1f 62.5%, #5d4a1f 100%);
    }

    .selec {
      background: linear-gradient(315deg, #b8d0e0 0%, #a6afb9 54%, #b8d0e0 80%);
    }

    .metal {
      background: linear-gradient(180deg, hsl(0, 0%, 78%) 0%,
          hsl(0, 0%, 90%) 47%,
          hsl(0, 0%, 78%) 53%,
          hsl(0, 0%, 70%)100%);
    }
  </style>



  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.9/js/bootstrap-select.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/4.7.0/firebase.js"></script>
  <script src="hammer.min.js"></script>
  <script src="bubbler.js"></script>


  <script src='D.js'></script>
  <script src='habilidades.js'></script>
  <script src='inventario.js'></script>
  <script src='rol.js'></script>
</head>

<body>

  <div class="container">
    <div class="pos-f-t">
      <div class="collapse" id="navbarToggleExternalContent">
        <div class="bg-dark p-4">
          <ul class="nav nav-tabs">
            <li class="col-sm h3"><a data-toggle="tab" style="color:white; font-family: Friedolin" href="#home">
                Personaje </a></li>
            <li class="col-sm h3"><a data-toggle="tab" style="color:white; font-family: Friedolin" href="#habilidades">
                Habilidades </a></li>
            <li class="col-sm h3"><a data-toggle="tab" style="color:white; font-family: Friedolin" href="#inventario">
                Inventario </a></li>
            <li class="col-sm h3"><a data-toggle="tab" style="color:white; font-family: Friedolin" href="#charts">
                Charts </a></li>
          </ul>
        </div>
      </div>
      <nav class="navbar navbar-dark bg-dark">
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarToggleExternalContent"
          aria-controls="navbarToggleExternalContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <input type="text" list="listaPJ" class="text-light bg-dark h3 " style="font-family: Old Europe" value="Rosssel"
          id="nombre">
        <datalist id="listaPJ">
          <option value="Personaje">
          <option value="Wolf">
          <option value="Rosssel">
          <option value="Blanc">
        </datalist>
        <button class="btn btn-danger" onclick="cargarPersonaje(true)">Cargar</button>
      </nav>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalTitle"
      aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editModalTitle">Editar</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body" id="editor">
            ...
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
            <button type="button" class="btn btn-danger" onclick="quitarObjeto()" data-dismiss="modal">Eliminar</button>
            <button type="button" class="btn btn-primary" onclick="nuevoObjeto()">Nuevo</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Hechizo -->
    <!-- <div class="modal fade" id="modalHechizo" tabindex="-1" role="dialog" aria-labelledby="modalHechizoTitle"
      aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title" id="modalHechizoTitle">Bola de fuego <span class="badge badge-pill badge-dark"> 7
              </span></h3>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body" id="editor">
            <form>
              <div class="input-group mb-3">
                <div class="input-group-prepend">
                  <span id="lbDuración" class="input-group-text">Duración: 130%</span>
                  <input id="iPMDuración" type="number" value="0" class="form-control number-input">
                  <span class="input-group-text"><i class="fas fa-dice-six"></i></span>
                  <input id="iDadosDuración" type="number" class="form-control number-input">
                  <button id="btDuraciónOK" class="btn btn-primary" type="button">OK</button>
                </div>

                <div class="input-group-prepend">
                  <span id="lbIntensidad" class="input-group-text">Intensidad: 130%</span>
                  <input id="iPMIntensidad" type="number" value="0" class="form-control number-input">
                  <span class="input-group-text"><i class="fas fa-dice-six"></i></span>
                  <input id="iDadosIntensidad" type="number" class="form-control number-input">
                  <button id="btIntensidadOK" class="btn btn-primary" type="button">OK</button>
                </div>
                <div class="number-input"></div>
                <div class="input-group-prepend">
                  <span id="lbHechizo" class="input-group-text">Hechizo: 130%</span>
                  <span class="input-group-text"><i class="fas fa-dice-six"></i></span>
                  <input id="iDadosHechizo" type="number" class="form-control number-input">
                  <span class="input-group-text">PM:</span>
                  <input id="iGastados" type="number" class="form-control number-input">
                </div>
              </div>
            </form>
            <div>
              PM disponibles: <span id="pmTotales" class="input-group-text"></span>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
            <button id="bLanzar" type="button" class="btn btn-primary" data-dismiss="modal">Lanzar</button>
          </div>
        </div>
      </div>
    </div> -->


    <!-- #region tabs -->
    <div class="tab-content">
      <div id="home" class="tab-pane fade in active">
        <!-- <input class="form-control" type="text" value="Personaje" id="nombre">
        <button onclick="cargarPersonaje()"> Cargar personaje</button> -->
        <table class="table table-hover">
          <thead>
            <!-- <th>Característica</th>
            <th>Valor</th>
            <th>Bonificación</th>
            <th>Valor</th> -->
          </thead>
          <tbody id="statsTable"></tbody>
        </table>
        <form>
          <div class="input-group mb-3">
            <div class="input-group-prepend">
              <span class="input-group-text">PG</span>
              <input id="iPG" type="number" class="form-control number-input">
              <button id="btPG" class="btn btn-light" onclick="pMax(PG)" type="button">PGMAX</button>
            </div>
            <div class="number-input"></div>
            <div class="input-group-prepend">
              <span class="input-group-text">PF</span>
              <input id="iPF" type="number" class="form-control number-input">
              <button id="btPF" class="btn btn-light" onclick="pMax(PF)" type="button">PFMAX</button>
            </div>
            <div class="number-input"></div>
            <div class="input-group-prepend">
              <span class="input-group-text">PM</span>
              <input id="iPM" type="number" class="form-control number-input">
              <button id="btPM" class="btn btn-light" onclick="pMax(PM)" type="button">PMMAX</button>
            </div>
          </div>
        </form>

      </div>
      <div id="habilidades" class="tab-pane fade">

        <div class="input-group ">
          <div class="input-group-prepend">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
          </div>
          <input class="form-control" id="buscar" type="text" placeholder="Buscar..">
        </div>
        <select class="selectpicker" id="columnas" multiple data-live-search="true" data-width="fit" multiple
          title="Seleccione columnas a mostrar">
          <option selected>nombre</option>
          <option>xp</option>
          <option>tipo</option>
          <option>valor</option>
        </select>
        <table class="table table-hover">
          <thead id="header">
            <!-- <th>Habilidad</th>
            <th>Tipo</th>
            <th>Valor</th> -->
          </thead>
          <tbody id="tbHab"></tbody>
        </table>
      </div>
      <div id="inventario" class="tab-pane fade">
        <button type="button" class="btn btn-primary" onclick="atras()"> <i class="fas fa-arrow-left"></i>
          Atras</button>

        <div class="input-group ">
          <div class="input-group-prepend">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
          </div>
          <input class="form-control" id="buscarObjeto" type="text" placeholder="Buscar..">
        </div>
        <select class="selectpicker" id="colInventario" multiple data-live-search="true" data-width="fit" multiple
          title="Seleccione columnas a mostrar">
          <option selected>nombre</option>
          <option selected>peso</option>
          <option>ctd</option>
          <option>valor</option>
          <option>daño</option>
          <option>pesa</option>
        </select>

        <div class="btn-group">
          <div class="dropdown">
            <button type="button" class="btn btn-dark dropdown-toggle" data-toggle="dropdown">
              Añadir
              <div class="dropdown-menu" onmouseover="this.style.color='red';" onmouseout="this.style.color='white';"
                style=" color: #fff;
              background-color: #000;
              border-color: #fff;">
                <a class="dropdown-item" onclick="editar(new Objeto()) ;$('#editModal').modal();">Objeto</a>
                <a class="dropdown-item" onclick="editar(new Contenedor()); $('#editModal').modal();"> <i
                    class="fas fa-box-open"></i> Contenedor</a>
                <a class="dropdown-item" onclick="editar(new Pociones()); $('#editModal').modal();"> <i
                    class="fas fa-flask"></i> Pociones</a>
                <a class="dropdown-item" onclick="editar(new Gema()); $('#editModal').modal();"><i
                    class="fas fa-gem"></i> Gema</a>
              </div>
          </div>
        </div>

        <!-- <button type="button" class="btn btn-danger" onclick="editar(new Objeto()) ;$('#editModal').modal();">Nuevo Objeto</button>
        <button type="button" class="btn btn-primary" onclick="editar(new Contenedor()); $('#editModal').modal();"> <i
            class="fas fa-box-open"></i>Nuevo Contenedor</button> -->
        <button type="button" class="btn btn-primary" onclick="copiar()"> <i class="fas fa-copy"></i> </button>
        <button type="button" class="btn btn-dark" onclick="cortar()"> <i class="fas fa-cut"></i></button>
        <button type="button" class="btn btn-success" onclick="pegar()"><i class="fas fa-paste"></i></button>
        <button type="button" class="btn btn-danger" onclick="eliminar()"><i class="fas fa-trash"></i></button>


        <table class="table table-hover">
          <thead id="hdInv">
            <!-- <th>Habilidad</th>
            <th>Tipo</th>
            <th>Valor</th> -->
          </thead>
          <tbody id="tbInv"></tbody>
        </table>
      </div>
      <div id="charts" class="tab-pane fade">
        <div>
          <!-- <canvas id="barChart"></canvas>
          <canvas id="radarChart"></canvas> -->
          <button class="btn btn-danger" onclick="lanzarHechizo()">Hechizo</button>

        </div>
      </div>
    </div>
    <!-- #endregion -->

    <!-- #region toast -->
    <div class="toast" style="position: absolute; top: 0; right: 0;">
      <!-- <div class="toast-header" style="background-color:black; color:white" >
    Toast Header
  </div> -->
      <div class="toast-body" style="background-color:black; color:white">
        Some text inside the toast body
      </div>
    </div>
    <!-- #endregion -->


    <p>Elige la fecha del Mundo</p>
    <input class="form-control" type="datetime-local" value="0177-07-07T00:00:01.0" id="fecha">
    <p id="texto"></p>

    <button onclick="act()"> Cambiar fecha y hora</button>
    <button onclick="saveStats()"> Guardar</button>

    <select class="selectpicker" id="hm" multiple data-live-search="true" data-width="fit" multiple
      title="Modificadores de Hechizo">
    </select>
    <div id="salida"></div>

    <!-- script de Bubble -->
    <script>
      // BUBBLE
      var options =
        [
          {
            icon: '<i class="fas fa-copy"></i>',
            label: 'Copiar',
            display: {
              color: 'white',
              background: 'darkcyan'
            },
            callback: function () {
              copiar();
            }
          },
          {
            icon: '<i class="fa fa-cut" aria-hidden="true"></i>',

            label: 'Cortar',
            display: {
              color: 'white',
              background: 'orangered'
            },
            callback: function () {
              cortar();
            }
          },
          {
            icon: '<i class="fa fa-paste" aria-hidden="true"></i>',
            label: 'Pegar',
            display: {
              color: 'white',
              background: 'green'
            },
            callback: function () {
              pegar();
            }
          },
          {
            icon: '<i class="fa fa-trash" aria-hidden="true"></i>',
            label: 'Borrar',
            display: {
              color: 'white',
              background: 'red'
            },
            callback: function () {
              eliminar();
            }
          },

        ];

      var context = new Bubbler(options);
    </script>

    <script>
      // el select guay
      $('select').selectpicker();

      //actualizar los puntos al cambiarlos en el editor

      PUNTOS.forEach(pt => {
        $('#i' + pt).change(function () {
          pj[pt] = parseInt($(this).val());
          pj.save();
        });
      });

      // $('#iPG').change(function () {
      //   pj[PG] = parseInt($(this).val());
      //   pj.save();
      // });

      // $('#iPF').change(function () {
      //   pj[PF] = parseInt($(this).val());
      //   pj.save();
      // });

      // $('#iPM').change(function () {
      //   pj[PM] = parseInt($(this).val());
      //   pj.save();
      // });

      var copiado = [];
      var selected = [];
      var nav = [];



      // $('#columnas').on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {
      //   // do something...
      //   // console.log($('#columnas').val());
      // });

      //buscar en habilidades
      //Buscar en la tabla
      $("#buscar").on("keyup", function () {

        var value = $(this).val().toLowerCase();
        //si empieza con > o <
        if (value.startsWith(">") || value.startsWith("<")) {
          var limit = parseFloat(value.substring(1));
          var signo = value[0];
          console.log("SIGNO;" + signo);

          $("#tbHab tr").filter(function () {
            var bool = false
            console.log($(this).html());
            var regex = /([0-9]+.)*[0-9]+/g; //la expresion regular para encontrar números en el html de la fila
            var found = $(this).html().match(regex);
            for (let i of found) { //por cada numero encontrado si cumple bool = true
              // console.log(parseInt(i)+":" +value.substring(1)); 
              // if(parseInt(i)>limit){

              if (eval('parseInt(i)' + signo + 'limit')) {
                bool = true;
                break;
              }
            }
            $(this).toggle(bool)
            // else
            // $(this).toggle(false);

          });
        }
        else //si no empieza con comparacion
          $("#tbHab tr").filter(function () {
            $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
          });
      });

      //buscar en el inventario
      $("#buscarObjeto").on("keyup", function () {

        var value = $(this).val().toLowerCase();
        //si empieza con > o <
        if (value.startsWith(">") || value.startsWith("<")) {
          var limit = parseFloat(value.substring(1));
          var signo = value[0];
          console.log("SIGNO;" + signo);

          $("#tbInv tr").filter(function () {
            var bool = false
            // console.log($(this).html());
            var regex = />([0-9]+.)*[0-9]+</g; //la expresion regular para encontrar números en el html de la fila
            var found = $(this).html().match(regex);
            console.log(found);
            for (let i of found) { //por cada numero encontrado si cumple la condición, bool = true
              i = i.replace("<", "").replace(">", "");
              console.log("i:" + i);
              if (eval('parseFloat(i)' + signo + 'limit')) {
                bool = true;
                break;
              }
            }
            $(this).toggle(bool)
          });
        }
        else //si no empieza con comparacion
          $("#tbInv tr").filter(function () {
            $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)//que contenga la cadena
          });
      });


      //TODO: MIRAR POR QUÉ NO FUNCIONA LO DE ABAJO

      // $("#buscar").on("keyup", buscar("#buscar", "tbHab"));
      // $("#buscarObjeto").on("keyup", buscar("#buscarObjeto", "tbInv"));

      // function buscar(busqueda,tabla) {
      //   var value = $(busqueda).val().toLowerCase();
      //   //si empieza con > o <
      //   if (value.startsWith(">") || value.startsWith("<")) {
      //     var limit = parseFloat(value.substring(1));
      //     var signo = value[0];
      //     console.log("SIGNO;" + signo);

      //     $(`#${tabla} tr`).filter(function () {
      //       var bool = false
      //       // console.log($(this).html());
      //       var regex = />([0-9]+.)*[0-9]+</g; //la expresion regular para encontrar números en el html de la fila
      //       var found = $(this).html().match(regex);
      //       console.log(found);
      //       for (let i of found) { //por cada numero encontrado si cumple la condición, bool = true
      //       i=i.replace("<","").replace(">","");
      //       console.log("i:"+i);
      //         if (eval('parseFloat(i)' + signo + 'limit')) {
      //           bool = true;
      //           break;
      //         }
      //       }
      //       $(this).toggle(bool)
      //     });
      //   }
      //   else //si no empieza con comparacion
      //     $(`#${tabla} tr`).filter(function () {
      //       $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)//que contenga la cadena
      //     });
      // }


      // if( /Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent) ) {
      //   $('.selectpicker').selectpicker('mobile');
      // }


      //cargar las habilidades
      //TODO: quitar esto??
      // for (habilidad in pj.habilidades) {
      //   console.log("Cargando las habilidades");

      //   var hh = new Habilidad();
      //   hh.setAll(habilidad);
      //   var row = $('#columnas');
      //   let habilidad = pj.getHabilidad(habilidad);

      //   for (key of habilidad) {//Esto serían todas
      //     row.append($("<option/>").text(habilidad[key]));
      //     console.log(habilidad[key]);
      //   }
      //   row.append($("<td/>").text(habilidad.v));
      //   console.log((row));
      // }

      // BOTONES DE PUNTOS

      function actPuntos() {
        $("#btPG").text("/  " + pj.getMaxPuntos(PG));
        $("#btPF").text("/  " + pj.getMaxPuntos(PF));
        $("#btPM").text("/  " + pj.getMaxPuntos(PM));

        $("#iPG").val(pj.getCar(PG));
        $("#iPF").val(pj.getCar(PF));
        $("#iPM").val(pj.getCar(PM));

      }


      function pMax(puntos) {
        valor = pj.getMaxPuntos(puntos);
        $("#i" + puntos).val(valor);
      }


      //Poblar con datos
      function tablaStats(idTabla = "statsTable") {
        var table = document.getElementById(idTabla);
        clear();

        for (let i in CP) {
          var row = table.insertRow();
          var tipo = row.insertCell(0);
          var cell = row.insertCell(1);
          let hTipo = row.insertCell(2);
          let hValor = row.insertCell(3);

          tipo.innerHTML = '<i data-toggle="tooltip"  id="lb' + CP[i] + '" title=' + CP[i] + '>' + CP[i] + '</i>';
          cell.innerHTML = '<i data-toggle="tooltip" contenteditable="true"  id="' + CP[i] + '" title=' + pj[CP[i]] + '>' + pj.getCar(CP[i]) + '</i>';
          hTipo.innerHTML = '<i data-toggle="tooltip"  id="' + TipoHabilidades[i] + '" title=' + TipoHabilidades[i] + '>' + TipoHabilidades[i] + '</i>';
          hValor.innerHTML = '<i data-toggle="tooltip"  id="' + pj.getCar(TipoHabilidades[i]) + '" title=' + pj[TipoHabilidades[i]] + '>' + pj.getCar(TipoHabilidades[i]) + '</i>';

        }
      }


      function tablaHabilidades() {
        var visibles = $("#columnas").val();
        // visibles.push(v);
        clear("tbHab");
        for (habilidad in pj.habilidades) {
          let hab = pj.getHabilidad(habilidad);
          objetoTabla(hab, "tbHab", visibles)
        };
      }
      //haccerlo de otra forma
      // function makeTable(container, pj = pj) {
      //   // var visibles = [
      //   //   "nombre",
      //   //   "tipo",
      //   //   "valor"
      //   // ]
      //   var visibles = $("#columnas").val();
      //   //creo que las cabeceras de las columnas
      //   createHeader(visibles);
      //   var table = $("<table/>").addClass("table table-hover");
      //   table = $("#tbHab");
      //   clear("tbHab");
      //   for (habilidad in pj.habilidades) {
      //     var hh = new Habilidad();
      //     hh.setAll(habilidad);
      //     var row = $("<tr/>");
      //     var habilidad = pj.getHabilidad(habilidad);

      //     for (key of visibles) {//Esto serían todas
      //       row.append($("<td/>").text(habilidad[key]));
      //       console.log(habilidad[key]);
      //     }
      //     row.append($("<td/>").html("<b>" + habilidad.v + "</b>"));
      //     table.append(row);
      //   }
      //   // return container.append(table);
      // }

      function createHeader(visibles, header = "header") {
        var th = document.getElementById(header);
        th.innerHTML = ""; //clear header
        var row = th.insertRow(0);
        for (var i in visibles) {
          var cell = row.insertCell(i);
          cell.innerHTML = '<b>' + visibles[i] + '</b>';
        }
        if (header === "header") {//si es habilidades
          // El total si sale siempre cambiar cuando se aplique tb a inventario
          // a no ser que ponga el peso total
          cell = row.insertCell();
          cell.innerHTML = '<b>' + "TOTAL" + '</b>';
          th.appendChild(row);
        }

      }

      function seleccionar(objeto) {
        console.log(selected);
        var pos = selected.indexOf(objeto);
        console.log("pos:" + pos);
        if (pos > -1) return; //ya está seleccionado
        selected.push(objeto);
        console.log(selected);
      }

      function deseleccionar(objeto) {
        var pos = selected.indexOf(objeto);
        console.log("Encontrado en pos:" + pos);
        if (pos > -1) selected.splice(pos, 1);
        console.log(selected);

      }


      function crearEventos(object, cell, key) {
        //si e sun contenedor cargo lso elementos que contiene
        if (object instanceof Contenedor) {

          if (key === "nombre") {
            // cell.style.color = "red";
            // cell.innerHTML += `   <button type="button" class="btn btn-secondary btn-sm" onclick="editar();" >Abrir</button>`
            cell.innerHTML += ` <i class="fas fa-box-open"></i> <span class="badge badge-dark">${object.objetos.length}</span>`

            cell.addEventListener("click", function () {
              let nc = object.nombre;
              let index = pj.inventario.navegar(nav).objetos.indexOf(object);
              nav.push(index);
              console.log(nav);
              cargarContenedor(object);
              // editar(object);

            });
          }
        }



        if (object instanceof Gema && key === "nombre") {
          cell.innerHTML = `<i class="fas fa-gem"></i> ` + cell.innerHTML;
          cell.innerHTML += ` <span class="badge " style="color:blue;" >${object.pm}/${object.capacidad}</span>`;
          // cell.innerHTML += ` <span class="badge badge-dark" style="background: linear-gradient(315deg, #b8d0e0 0%, #a6afb9 54%,  #b8d0e0 80% );">${object.ctd}</span>`

        }
        if (object instanceof Pociones && key === "nombre") {

          let index = object.efectos.search(/\(/g);
          let s = object.efectos.substring(index, object.efectos.length)
          cell.innerHTML = `<i class="fas fa-flask" ></i> ` + cell.innerHTML;
          cell.innerHTML += ` <span class="badge " style="color:blue;" >${s}</span>`;
          var ht = new Hammer(cell);
          ht.on("press tap", function (ev) {
            console.log(ev);
            if (ev.type == "tap")
              console.log("TAP");
            else
            object.tomar();
          });
          // cell.innerHTML += ` <span class="badge badge-dark" style="background: linear-gradient(315deg, #b8d0e0 0%, #a6afb9 54%,  #b8d0e0 80% );">${object.ctd}</span>`

        }

        if (object instanceof Objetos && key === "nombre") {
          if (object[key] == "mo") cell.innerHTML += ` <span class="badge badge-dark gold" >${object.ctd}</span>`;
          else
            if (object[key] == "mm") cell.innerHTML += ` <span class="badge metal" >${object.ctd}</span>`;
            else
              cell.innerHTML += ` <span class="badge badge-dark"  >${object.ctd}</span>`;
          // cell.innerHTML += ` <span class="badge badge-dark" style="background: linear-gradient(315deg, #b8d0e0 0%, #a6afb9 54%,  #b8d0e0 80% );">${object.ctd}</span>`

        }




        if (object instanceof Objeto) {
          var hammertime = new Hammer(cell);
          hammertime.on('swipe', function (ev) {
            console.log(ev);
            if (ev.direction == 2) {
              // cell.parentElement.style.background = "white";
              cell.parentElement.classList.remove("selec");
              deseleccionar(object);
            } //a izq
            else {
              // cell.parentElement.style.background = "green";
              cell.parentElement.classList.add("selec");
              seleccionar(object);
            } //a derechas selecciona
          });


          // var mc = new Hammer.Manager(cell);


          // // Tap recognizer with minimal 2 taps
          // mc.add(new Hammer.Tap({ event: 'doubletap', taps: 2 }));
          // // Single tap recognizer
          // mc.add(new Hammer.Tap({ event: 'singletap' }));


          // // we want to recognize this simulatenous, so a quadrupletap will be detected even while a tap has been recognized.
          // mc.get('doubletap').recognizeWith('singletap');
          // // we only want to trigger a tap, when we don't have detected a doubletap
          // mc.get('singletap').requireFailure('doubletap');


          // mc.on("singletap doubletap swipe", function (ev) {
          //   console.log( "Toque " +ev.type + " ");
          // });

          cell.addEventListener("dblclick", function () {
            // alert("mover objeto") + object.nombre;
            //modifico el editor modal
            editar(object);
            //y lo muestro
            $("#editModal").modal();
          });

        }

        // if (object instanceof Pociones) {
        //   objetoActual = object;
        //   console.log("me meto en pociones");
        //   cell.addEventListener("dbclick", function () {
        //     console.log("Voy a tomar");
        //     object.tomar();
        //   });
        // }

        if (object instanceof Habilidad) {
          if (key === "xp") { //si doy un click en xp +1
            cell.addEventListener("click", function () {
              //lo incremento y guardo en firebase 
              // object.xp++;
              object.addXP(1);
              object.save();
            });
          }

          if (key === "nombre") {
            cell.addEventListener("click", function () {
              //modifico el editor modal
              editar(object);
              //y lo muestro
              $("#editModal").modal();
            });

          }
        }
        // else
        //   cell.addEventListener("click", function () {
        //     console.log(object);
        //   });

      }

      //TODO: editar los objetos con el modal

      function editar(objeto) {
        // console.log("Editar:"+objeto );
        objetoActual = objeto;
        const keys = Object.keys(objeto);
        const values = Object.values(objeto);

        var editor = document.getElementById("editor");
        editor.innerHTML = ""; //clear editor
        var id = -1;
        var k = -1
        var v = -1;
        for (i = 0; i < keys.length; i++) {
          if (i == 0) id = values[i];
          k = keys[i];
          v = values[i];

          console.log(k+" ->"+v )

          editor.innerHTML = editor.innerHTML + ' <b>' + k.toUpperCase() + ':</b>' +
          `<input data-toggle="tooltip"  id="edit${k}" value='${v}'' title="${k}" ><br>`
            // '<input data-toggle="tooltip"  id="edit' + keys[i] + '" value=' + values[i] + ' title=' + keys[i] + ' ><br>';
          //Probar con forms

        }
        editor.innerHTML = editor.innerHTML + `<button type="button" class="btn btn-success" onclick="guardarObjeto()">Guardar</button>`

      }

      function nuevoObjeto() {
        const keys = Object.keys(objetoActual);
        var values = Object.values(objetoActual);
        let nuevoObjeto = new objetoActual.constructor();

        console.log("Nuevo objeto:" + nuevoObjeto.constructor.name);
        //guardo los valores editados en el objeto
        for (i = 0; i < keys.length; i++) {
          var valor = $('#edit' + keys[i]).val();
          if (isNumber(valor)) values[i] = +valor;
          else values[i] = valor;
          nuevoObjeto[keys[i]] = values[i];
        }
        pj.inventario.navegar(nav).add(nuevoObjeto);
        console.log(nuevoObjeto);
        console.log("en contenedor");
        console.log(pj.inventario.navegar(nav));
        try {
          nuevoObjeto.save();
        } catch (error) {
          console.log(`El objeto ${nuevoObjeto.nombre} no se puede guardar`);
          console.log(pj);
          console.log(pj.inventario.navegar(nav));
          pj.save();//guardo el personaje entero
          cargarPersonaje();
          // alert();
        }

      }

      function quitarObjeto() {
        if (objetoActual instanceof Objeto) {
          pj.inventario.navegar(nav).sacar(objetoActual);
          // contenedorActual.sacar(objetoActual);
          // console.log(contenedorActual);
          console.log("Después de quitar:");
          console.log(pj.inventario.navegar(nav));
          try {
            console.log(`Quito ${objetoActual.nombre} de ${pj.inventario.navegar(nav).nombre}`);
            pj.save();//guardo
            // cargarPersonaje();
          } catch (error) {
            console.log(`Error al quitar ${objetoActual.nombre} de ${pj.inventario.navegar(nav).nombre}`);
            // alert();
          }
        }

      }

      function guardarObjeto() {

        const keys = Object.keys(objetoActual);
        var values = Object.values(objetoActual);

        console.log("Editar objeto:");
        //guardo los valores editados en el objeto
        for (i = 0; i < keys.length; i++) {
          var valor = $('#edit' + keys[i]).val();
          if (isNumber(valor)) values[i] = +valor;
          else values[i] = valor;
          objetoActual[keys[i]] = values[i];
        }
        console.log(objetoActual);
        var id = values[0]; //Imaginamos que el id es el 1er campo
        try {
          objetoActual.save();
        } catch (error) {
          console.log(`El objeto ${objetoActual.nombre} no se puede guardar`);
          console.log(pj);
          pj.save();

          // if (contenedorActual) {
          //   console.log(contenedorActual);
          //   cargarContenedor(contenedorActual);
          // }
          // else
          // cargaInventario(pj);
          cargarPersonaje(pj);


          // alert();
        }

      }

      function isNumber(value) {
        if (value instanceof Number)
          return true
        else
          return !isNaN(value);
      }


      function saveStats() {
        for (let i in CP) {
          var x = parseInt(document.getElementById(CP[i]).innerHTML);
          // var x = eval(document.getElementById(CP[i]).innerHTML);
          console.log(x);
          pj[CP[i]] = x;
        }
        pj.nombre = $("#nombre").val();
        pj.act();
        tablaStats();
        pj.backup = null; //para que no se vuelva a cargar con los efectos.

        pj.save();

        // var h1 = new Habilidad("AAAA", "Agilidad", 7);
        // console.log(h1);
        // // h1.save();
        // pj.setHabilidad(h1);

        // var h1 = new Habilidad("Correr", "Agilidad", 100);
        // var b1 = new BonHabilidad("Correr", 0, 10, 10);
        // h1.activarBon(b1);

        // pj.setHabilidad(h1);
        // pj.setHabilidad(new Habilidad("Trepar", "Agilidad", 15));
        // pj.setHabilidad(new Habilidad("Saltar", "Agilidad", 30));
        // pj.setHabilidad(new Habilidad("Esquivar", "Agilidad", 25));

        console.log("PERSONAJE GUARDADO:");
        console.log(pj);

        // makeTable($("#habilidades"), pj);

        // efFuerza = new Efecto("fuerza", `this.sb(FUE,"+5")`, fechaMundo.add("dia", 4));
        // efDes = new Efecto("des", `this.DES+=5`, fechaMundo.add("dia", 4));
        // efTam = new Efecto("tamaño", `this.sb(TAM,5)`, fechaMundo.add("dia", 4));
        // efAsp = new Efecto("aspecto", `this.ASP=18`, fechaMundo.add("dia", 4));
        // efReflex = new Efecto("Reflejos felinos", `this.DES+=5; this.sb(Agilidad,'+5') `, fechaMundo.add("dia", 4));
        // efPermanente = new Efecto("Permanente", `this.ASP+=5; this.sb(Comunicación,'+5') `);


        // pj.addEfecto(efFuerza)
        // pj.addEfecto(efDes)
        // pj.addEfecto(efTam)
        // pj.addEfecto(efAsp)
        // pj.addEfecto(efReflex)
        // pj.addEfecto(efPermanente)

        // pj.aplicarEfectos()
        // pj.nombre = "Copia";
        // pj.save();

      }

      function clear(id = "statsTable") {
        var tb = document.getElementById(id);
        tb.innerHTML = ""; //clear body
      }

      function act() {
        var x = document.getElementById("fecha").value;
        document.getElementById("texto").innerHTML = x;
        // console.log("fechaMundo x :"+x);
        fechaMundo = new Date(x + ".000Z");
        // console.log("fechaMundo:"+fechaMundo.toISOString());
        document.getElementById("texto").innerHTML = pj.aplicarEfectos()
        pj.act();
        tablaStats();

      }

      function dados(nombre) {

        let v = Math.trunc(Math.random() * 100 + 1);
        console.log(v);
        $(nombre).val(v);

      }
      function lanzarHechizo(hechizo) {

        let h = new Hechizo("Hechizo", 7, 100, null);
        const porcentajeInicial = h.valor;
        $("#modalHechizo").modal();
        $("#pmTotales").text(pj.getCar(PM) + "+" + pj.pmGemas() + "=" + (pj.getCar(PM) + pj.pmGemas()));
        intensidad = pj.getHabilidad("Intensidad");
        duración = pj.getHabilidad("Duración");
        pIntensidad = intensidad.v;
        pDuración = duración.v;
        let pmGastados = 0;
        let valorIntensidad = $("#iPMIntensidad").val();
        let valorDuración = $("#iPMDuración").val();
        let penalizacion = 0;
        let ipm, dpm;
        let tHechizo, tIntensidad, tDuración = TipoTirada.EXITO;
        // var xpHechizo, xpIntensidad, xpDuración = 0;
        let pmIntensidad, pmDuración, pmHechizo = 0;
        let intensidadReal, duraciónReal = 0;

        ipm = //$("#iPMIntensidad");
          document.getElementById("iPMIntensidad");

        dpm =
          document.getElementById("iPMDuración");

        var dDuración = document.getElementById("iDadosDuración");
        var dIntensidad = document.getElementById("iDadosIntensidad");
        var i = document.getElementById("iDadosHechizo");

        $("#lbIntensidad").text(`Intensidad: ${pIntensidad}%`);
        $("#lbDuración").text(`Duración: ${pDuración}%`);



        function swDuración() {
          if (dpm.value == 0) { pmDuración = 0; return; }
          switch (tDuración) {
            case (SUPERCRITICO):
              duraciónReal = dpm.value + 5;
              pmDuración = 1;
              dDuración.style.background = "red";
              break;
            case (CRITICO):
              duraciónReal = dpm.value + 3;
              pmDuración = 1;
              dDuración.style.color = "red";
              break;
            case (ESPECIAL):
              duraciónReal = dpm.value + 1;
              pmDuración = valorDuración;
              dDuración.style.color = "green";
              break;
            case (EXITO):
              duraciónReal = valorDuración;
              pmDuración = valorDuración;
              dDuración.style.color = "black";
              break;
            case (FALLO):
              duraciónReal = 0;
              pmDuración = 1;
              dDuración.style.color = "black";
              break;
            default:
              ;
          }
        }
        function swIntensidad() {
          if (ipm.value == 0) { pmIntensidad = 0; return; }
          switch (tIntensidad) {
            case (SUPERCRITICO):
              intensidadReal = ipm.value + 5;
              pmIntensidad = 1;
              penalizacion = 0;
              dIntensidad.style.color = "red";
              break;
            case (CRITICO):
              intensidadReal = ipm.value + 3;
              pmIntensidad = 1;
              penalizacion = 0;
              dIntensidad.style.color = "red";
              break;
            case (ESPECIAL):
              intensidadReal = ipm.value + 1;
              pmIntensidad = valorIntensidad;
              penalizacion = 0;
              dIntensidad.style.color = "green";
              break;
            case (EXITO):
              intensidadReal = valorIntensidad;
              pmIntensidad = valorIntensidad;
              dIntensidad.style.color = "black";
              break;
            case (FALLO):
              intensidadReal = 0;
              pmIntensidad = 1;
              dIntensidad.style.color = "black";
              break;
            default:
              ;
          }

        }
        function swHechizo() {
          switch (tHechizo) {
            case (SUPERCRITICO):
              pmHechizo = 1;
              dHechizo.style.color = "red";
              break;
            case (CRITICO):
              pmHechizo = 1;
              dHechizo.style.color = "red";
              break;
            case (ESPECIAL):
              pmHechizo = h.pm;
              dHechizo.style.color = "green";
              break;
            case (EXITO):
              pmHechizo = h.pm;
              dHechizo.style.color = "black";
              break;
            case (FALLO):
              pmHechizo = 1;
              break;
            default:
              ;
          }

        }

        function act() {
          //% de habilidad
          swDuración();
          swIntensidad();
          swHechizo();

          h.valor = porcentajeInicial - penalizacion;

          $("#lbHechizo").text(`Hechizo: ${h.v}%`);

          let suma = pmIntensidad + pmDuración + pmHechizo;
          console.log("SUMA:" + parseInt(pmIntensidad) +
            parseInt(pmHechizo) +
            parseInt(pmDuración));

          pmGastados = parseInt(pmIntensidad) +
            parseInt(pmHechizo) +
            parseInt(pmDuración);
          // console.log("Gastados");
          // console.log(pmGastados);
          $("#iGastados").val(pmGastados);

          // $("#iGastados").val(parseInt(pmIntensidad) +
          //   parseInt(pmHechizo) +
          //   parseInt(pmDuración));

        }

        function cambiaIntensidad() {
          valorIntensidad = $("#iPMIntensidad").val();
          //TODO: hacerlo con bonificación de verdad BonHabilidad
          penalizacion = valorIntensidad * 5;
          act();
        }

        ipm.addEventListener("change", function () {
          valorDuración = $("#iPMDuración").val();
          console.log("#iPMDuración" + pmDuración);
          act();
        }); ("change", cambiaIntensidad);

        dpm.addEventListener("change", function () {
          valorDuración = $("#iPMDuración").val();
          console.log("#iPMDuración" + pmDuración);
          act();
        });

        dDuración.addEventListener("change", function () {
          tDuración = duración.tirada(dDuración.value);
          // console.log("Duración" + (tDuración));
          act();
        });

        dIntensidad.addEventListener("change", function () {
          tIntensidad = intensidad.tirada(dIntensidad.value);
          // console.log("Intensidad" + (tIntensidad));
          //TODO: hacerlo con bonificación de verdad BonHabilidad
          penalizacion = valorIntensidad * 5;
          act();
        });

        dHechizo.addEventListener("change", function () {
          tHechizo = h.tirada(dHechizo.value);
          // console.log("Hechizo" + (tHechizo));
          //TODO: hacerlo con bonificación de verdad BonHabilidad
          act();
        });

        $("#lbIntensidad").text(`Intensidad: ${pIntensidad}%`);

        $("#bLanzar").one("click", function () { //one para que no lo lance cada vez que ejecuto lanzar hechizo
          pj.gastarPM(pmGastados, true);
          // pj.modificarPuntos(PM, pmGastados * -1);
          console.log(pmGastados * -1);
          intensidad.xpTirada(dIntensidad.value);
          duración.xpTirada(dDuración.value);
          //El hechizo deberia ser la tirada con penalización
          console.log(`dur:${pmDuración} , int:${pmIntensidad}, hechi:${pmHechizo} = ${pmGastados * -1}`);
          pj.save();
          console.log("***********SE HA PULSADO LANZAR");
        });

      }

      //Todas las variables necesarias para los hechizos


      /**
       * Crea la interfaz para lanzar un hechizo
       * @param hechizo: el hechizo 
       */
      function hechizos(hechizo) {
        // las habilidades
        var nombres = [
          "Multiconjuro",
          "Sobrepotencia",
          "Refuerzo",
          "Alcance",
          "Duración",
          "Intensidad",
          "Puntería",
          "Velocidad"
        ]

        var iPM = [];
        /**
          *Puntos de intensidad gastados
          */
        var pig = []

        var habilidades = []
        var html = ""
        var h;
        var dados = [];
        var pmGastados = 0;

        //penalizacion al hechizo por Intensidad
        var penalizacion = 0

        document.getElementById("salida").innerHTML = "";
        document.getElementById("hm").innerHTML = "";
        //pongo todas las habilidades mágicas en habilidades
        nombres.forEach(n => {
          h = pj.getHabilidad(n);
          if (h) {
            habilidades.push(h)
            document.getElementById("salida").innerHTML +=
              `
      <div id="grupo${h.nombre}" class="input-group-prepend">
        <span id="lb${h.nombre}" class="input-group-text col-4">${h.nombre}: ${h.v}%</span>
        <input id="iPM${h.nombre}" type="number" value="0" class="form-control number-input col-2">
        <span class="input-group-text col-1"  id="d${h.nombre}"><i class="fas fa-dice-six"></i></span>
        <input id="iDados${h.nombre}" type="number" class="form-control number-input col-2">
        <button id="bt${h.nombre}OK" class="btn btn-primary col-1" type="button">OK</button>
      </div>
        `
          }
        });
        //selectpicker con las habilidades a mostrar  onclick="dados('#iDados${h.nombre}')"
        var hm = document.getElementById("hm");

        //actualizar las habilidades mágicas(habilidad,valor)

        /**
         * actHM
         ** Función que actualiza las habilidades de magia
         * tras un cambio
         *@author Roberto Lozano
        */
        function actHM(h, valor) {
          // console.log();
          let n = h.nombre;
          var v = h.tirada(valor);
          let pm = parseInt($(`#iPM${n}`).val());
          let i = document.getElementById(`iDados${h.nombre}`);
          switch (v) {
            case (TipoTirada.SUPERCRITICO):
              // pmHechizo = 1;
              i.style.color = "red";
              iPM[n] = pm + 5
              pig[n] = 1;

              break;
            case (TipoTirada.CRITICO):
              console.log("CRITICO");
              // pmHechizo = 1;
              i.style.color = "red";
              iPM[n] = pm + 3
              pig[n] = 1; //GASTA 1
              break;
            case (TipoTirada.ESPECIAL):
              console.log("ESPECIAL");
              // pmHechizo = h.pm;
              i.style.color = "green";
              iPM[n] = pm;
              pig[n] = pm - 1; //gasta uno menos
              break;
            case (TipoTirada.EXITO):
              console.log("EXITO");
              // pmHechizo = h.pm;
              i.style.color = "black";
              iPM[n] = pig[n] = pm;

              //si es intensidad y éxito normal resta al hechizo
              if (h.nombre == "Intensidad")
                penalizacion = pm * 5;
              break;
            case (TipoTirada.FALLO):
              console.log("FALLO");
              // pmHechizo = 1;
              i.style.color = "grey";
              iPM[n] = 0;
              pig[n] = 1
              break;
            default:
              ;
          }
          console.log(n + ":" + iPM[n] + "gastados" + pig[n])
          totalGastado();
        }

        function lanzarDados(nombre, h) {
          let v = Math.trunc(Math.random() * 100 + 1);
          console.log(v);
          $(nombre).val(v);
          actHM(h, v);

        }

        function totalGastado() {
          let suma = 0;
          for (let v in pig)
            suma += pig[v]
          console.log(suma);
          return suma;
        }


        // console.log("habilidades");
        // console.log(habilidades);
        habilidades.forEach(h => {
          console.log(h);
          //por cada habilidad mágica se añade un option
          hm.add(new Option(h.nombre));
          $("#hm").selectpicker('refresh');
          // $("#hm").add(new Option(h.nombre));

          $(`#d${h.nombre}`).click(function () {
            lanzarDados(`#iDados${h.nombre}`, h);

          });

          $(`#iPM${h.nombre}`).change(function () {
            valor = event.target.value;
            console.log(`#iPM${h.nombre} valor: ${event.target.value}`);
            iPM[h.nombre] = valor;
          });

          $(`#iDados${h.nombre}`).change(function () {
            valor = event.target.value;
            console.log(`#iDados${h.nombre} valor: ${event.target.value}`);
            dados[h.nombre] = valor;
            actHM(h, valor)
          });

          // document.getElementById(`iDados${h.nombre}`).addEventListener('change', (event) => {
          //   console.log(`Se ha cambiado el dado a ${event.target.value}`);
          // });

          // hide(h.nombre);

        });

        $("#hm").on("changed.bs.select",
          function (e, clickedIndex, newValue, oldValue) {
            let t = (hm[clickedIndex].text);
            if (newValue)
              show(t);
            else
              hide(t);

          });
        // document.getElementById("salida").innerHTML=html


      }

      function hide(habilidad) {
        $("#grupo" + habilidad).hide("slow");
        //opcional dejar los valores en 0
        // iPM[habilidad] = 0
        // pig[habilidad] = 0 
      }

      function show(habilidad) {
        $("#grupo" + habilidad).show("slow");
      }

      function atras() {
        nav.pop();
        ir();
      }
      function ir() {

        console.log("CARGA CONTENEDOR");
        console.log(pj.inventario.navegar(nav).nombre);
        cargarContenedor(pj.inventario.navegar(nav));

      }
      function copiar() {
        copiado = selected;
        // copiado.push(objetoActual);
        // console.log(copiado);
        // $('.toast-body').text(`Objeto "${objetoActual.nombre}"" copiado`)

        // $('.toast').toast({ delay: 4000 });
        // $('.toast').toast('show');
      }

      function cortar() {
        // copiado.push(objetoActual);
        copiar();
        eliminar();
        // pj.inventario.navegar(nav).sacar(objetoActual);
        // pj.save();
        // cargarPersonaje(true);
      }

      function eliminar() {
        selected.forEach(element => {
          pj.inventario.navegar(nav).sacar(element);
        });
        pj.save();

      }

      function pegar() {
        copiado.forEach(element => {
          if (element instanceof Objeto) {
            pj.inventario.navegar(nav).add(element);
          }
        });
        copiado = [];
        selected = [];
        pj.save()
        // cargarPersonaje(true);

      }


      //las funciones de rol.js

      function cargar(ruta) {
        console.log("CARGAR RUTA:" + ruta);
        fbActual = database.ref(ruta);
        //si lo hago así es menos eficiente porque siempre que haya un cambio
        //carga todas las habilidades

        //por si quiero ordenar de algún modo: .orderByChild("valor").on(...

        fbActual.on('value', function (item) {
          clear("tbHab");
          //this is saying foreach order do the following function...
          item.forEach(function (firebaseReference) {
            a = firebaseReference.val();
            var nh = new Habilidad();
            nh.setAll(a);
            pj.setHabilidad(nh);
            // console.log(a); //check your console to see it!
            // addObjet2Table(nh,"tbHab");
          });
          //TODO: poner aquí el header??
          // makeTable("", pj);
        });

        // Get the hab that has changed

        // fbActual.on("child_changed", function (snapshot) {
        //   var changedHab = snapshot.val();
        //     var nh = new Habilidad();
        //     nh.setAll(changedHab);
        //     pj.setHabilidad(nh);
        //   console.log("Nodo cambiado");
        //   console.log(changedHab);
        //   makeTable("", pj);
        // });

        //Tal vez debería hacerlo para added y removed

        // $('#myTable').css('textTransform', 'capitalize');
      }


      // function cargarRuta() {
      //   cargar($("#rutas").val());
      // }
      function cargarHabilidad(personaje = pj) {
        cargar(`personajes/${personaje.nombre}/habilidades/`);
      }

      function cargaInventario(pj) {
        console.log("Carga Inventario");
        nav = [];
        cargarContenedor(pj.inventario.navegar(nav));
      }

      function cargarContenedor(object) {
        object = pj.inventario.navegar(nav);
        if (!(object instanceof Contenedor)) return; //si no es contenedor
        //hago éste el contenedor actual
        // contenedorActual = object;
        // console.log("Contenedor Act:");
        console.log("Objeto Act:");
        // console.log(pj.inventario.navegar(nav));
        console.log(object);
        clear("tbInv"); //limpio la tabla
        let visibles = $("#colInventario").val();
        createHeader(visibles, "hdInv");
        object.objetos.forEach(function (element) {
          // addObjet2Table(element, "tbInv")
          objetoTabla(element, "tbInv", visibles);
        });
        addObjet2Table(["peso Total", roundTo(3, object.pesa)], "tbInv")
      }

      function roundTo(precision, num) {
        //redondeamos a gramos  
        return +(Math.round(num + "e+" + precision) + "e-" + precision);
      }

      function cargarPersonaje(nombre) {
        if (nombre == true) {
          // contenedorActual = null;
          nav = [] //Llamo desde el boton y voy al inventario general
        }

        nombre = $("#nombre").val();
        let ruta = `personajes/${nombre}/`;
        // console.log("CARGAR RUTA:" + ruta);
        fbActual = database.ref(ruta);

        // si lo hago así es menos eficiente,
        // porque siempre que haya un cambio
        // donde sea me, va a cargar el personaje entero
        fbActual.on('value', function (item) {
          console.log("onvalue personaje" + item.val().nombre);
          pj = new Animal({});
          pj.setAll(item.val());

          console.log("CARGA EL PUTO PERSONAJE:" + pj.nombre);
          console.log(nav);
          // console.log(pj);
          document.title = pj.nombre;

          // makeTable("", pj);
          tablaHabilidades();
          tablaStats();
          actPuntos();

          //Inventario nuevo TODO: quitar
          // pj.inventario = creaInventario();
          // console.log(pj.inventario.darContenedores());
          // console.log("ARMAS");
          // console.log(pj.inventario.darClase(Arma));
          // console.log("Objetos");
          // console.log(pj.inventario.darClase(Objetos));


          //TODO: hacer que funcione
          // if (contenedorActual) {
          //   console.log("Contenedor Act:");
          //   console.log(contenedorActual);
          //   cargarContenedor(contenedorActual);
          // }
          // else
          cargarContenedor();

          // console.log("No ContenedorAct: CargaInventario");
        });

        //  podría hacerlo con once y luego responder a cambios en habilidades,
        //  en inventario y en las características

        // fbActual.once("value", function (data) {
        //    pj = new Animal({});
        //    pj.setAll(item.val());
        //    // mostrar las demás: makeTable("", pj), etc
        // });

        // fbActual.on("child_changed", function (snapshot) {
        //   var changedPost = snapshot.val();
        //   console.log("The updated post title is " + changedPost.title);
        // });

        // Mover un objeto
        //  pj.inventario.mover(1, a.inventario);
        //  console.log(pj);
        //  console.log(a);
        //  pj.save();
        //  a.save();

      }


      // var lastObject={};

      function addObjet2Table(object, tabla) {

        const keys = Object.keys(object);
        // const lastKeys = Object.keys(lastObject);
        // lastObject= object;

        const values = Object.values(object);

        var table = document.getElementById(tabla);
        var row = table.insertRow();

        // if(JSON.stringify(keys)==JSON.stringify(lastKeys)) console.log("Misma fila");
        // // if(keys.length==lastKeys.length) console.log("Misma fila");
        // else  createHeader(keys, "hdInv") //console.log("Fila distinta:"+ lastKeys +"<->"+ keys);

        var id = -1
        for (i = 0; i < keys.length; i++) {
          if (i == 0) id = values[i];
          // var k = keys[i];
          // var v = values[i];
          var cell = row.insertCell(i);
          crearEventos(object, cell);

          cell.innerHTML = '<i data-toggle="tooltip"  id="' + id + "|" + keys[i] + "|" + values[i] + '" title=' + keys[i] + '>' + values[i] + '</i>';
          // cell.tooltip({title: "<h1><strong>HTML</strong> $keys[i] <code>the</code> <em>tooltip</em></h1>", html: true, placement: "bottom"});
          // console.log(keys[i] + ":" + values[i]); //check your console to see it!
        }

      }

      function objetoTabla(object, tabla, visibles) {
        var table = document.getElementById(tabla);
        var row = table.insertRow();

        var i = 0
        for (key of visibles) {//Esto serían todas
          var cell = row.insertCell(i);
          let valor;
          //Hacer un get de property en vez de método
          // if (key.includes("()")) {//si es un método
          //   valor = eval("object." + key);
          // }
          // else {
            if (i == 0) id = object[key];
            // crearEventos(object, cell, key);
            // console.log(object[key]);
            valor = object[key];
          // }

          if (valor === undefined) valor = "";

          cell.innerHTML = '<i data-toggle="tooltip"  id="' + id + "|" + key + "|" + valor + '" title=' + key + '>' + valor + '</i>';
          crearEventos(object, cell, key);
          i++;
        }

        if (object instanceof Habilidad) {
          // en habilidad pongo el total (.v) y un tooltip con el E y C
          var cell = row.insertCell(i); cell.innerHTML =
            `<i data-toggle="tooltip" title="E: ${object.e}\nC: ${object.c} "> <b> ${object.v}</b> </i>`
        }

      }

    </script>

</body>

</html>