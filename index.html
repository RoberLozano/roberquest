<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8'>
  <meta http-equiv='X-UA-Compatible' content='IE=edge'>

  <title>Pruebas de RoberQuest</title>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.9/css/bootstrap-select.css" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css"
    integrity="sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ" crossorigin="anonymous">
  <style type="text/css">
    @font-face {
      font-family: "Friedolin";
      src: url("Friedolin.ttf");
    }

    @font-face {
      font-family: "MediciText";
      src: url("MediciText.otf");
    }

    @font-face {
      font-family: "Old Europe";
      src: url("Old Europe.ttf");
    }

    h5 {
      font-family: Friedolin;
      font-size: 300%;
    }

    h2 {
      font-family: MediciText;
    }

    .number-input {
      width: 60px;
    }
  </style>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.9/js/bootstrap-select.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/4.7.0/firebase.js"></script>


  <script src='habilidades.js'></script>
  <script src='inventario.js'></script>
  <script src='rol.js'></script>
</head>

<body>

  <div class="container">
    <div class="pos-f-t">
      <div class="collapse" id="navbarToggleExternalContent">
        <div class="bg-dark p-4">
          <ul class="nav nav-tabs">
            <li class="col-sm h3"><a data-toggle="tab" style="color:white; font-family: Friedolin" href="#home">
                Personaje </a></li>
            <li class="col-sm h3"><a data-toggle="tab" style="color:white; font-family: Friedolin" href="#habilidades">
                Habilidades </a></li>
            <li class="col-sm h3"><a data-toggle="tab" style="color:white; font-family: Friedolin" href="#inventario">
                Inventario </a></li>
            <li class="col-sm h3"><a data-toggle="tab" style="color:white; font-family: Friedolin" href="#charts">
                Charts </a></li>
          </ul>
        </div>
      </div>
      <nav class="navbar navbar-dark bg-dark">
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarToggleExternalContent"
          aria-controls="navbarToggleExternalContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <input type="text" list="listaPJ" class="text-light bg-dark h3 " style="font-family: Old Europe"
          value="Personaje" id="nombre">
        <datalist id="listaPJ">
          <option value="Personaje">
          <option value="Wolf">
          <option value="Rosssel">
          <option value="Blanc">
        </datalist>
        <button class="btn btn-danger" onclick="cargarPersonaje(true)">Cargar</button>
      </nav>
    </div>

    <h2 id="titulo">Roberquest</h2>

    <!-- Modal -->
    <div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalTitle"
      aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editModalTitle">Editar</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body" id="editor">
            ...
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
            <button type="button" class="btn btn-danger" onclick="quitarObjeto()" data-dismiss="modal">Eliminar</button>
            <button type="button" class="btn btn-primary" onclick="nuevoObjeto()">Nuevo</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Hechizo -->
    <div class="modal fade" id="modalHechizo" tabindex="-1" role="dialog" aria-labelledby="modalHechizoTitle"
      aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title" id="modalHechizoTitle">Bola de fuego <span class="badge badge-pill badge-dark"> 7
              </span></h3>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body" id="editor">
            <form>
              <div class="input-group mb-3">
                  <div class="input-group-prepend">
                      <span id="lbDuración" class="input-group-text">Duración: 130%</span>
                      <input id="iPMDuración" type="number" value="0" class="form-control number-input">
                      <span class="input-group-text"><i class="fas fa-dice-six"></i></span>
                      <input id="iDadosDuración" type="number" class="form-control number-input">
                      <button id="btDuraciónOK" class="btn btn-primary" type="button">OK</button>
                    </div>


                <div class="input-group-prepend">
                  <span id="lbIntensidad" class="input-group-text">Intensidad: 130%</span>
                  <input id="iPMIntensidad" type="number" value="0" class="form-control number-input">
                  <span class="input-group-text"><i class="fas fa-dice-six"></i></span>
                  <input id="iDadosIntensidad" type="number" class="form-control number-input">
                  <button id="btIntensidadOK" class="btn btn-primary" type="button">OK</button>
                </div>
                <div class="number-input"></div>
                <div class="input-group-prepend">
                  <span id="lbHechizo" class="input-group-text">Hechizo: 130%</span>
                  <span class="input-group-text"><i class="fas fa-dice-six"></i></span>
                  <input id="iDadosHechizo" type="number" class="form-control number-input">
                  <span class="input-group-text">PM:</span>
                  <input id="iGastados" type="number" class="form-control number-input">
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-primary" onclick="nuevoObjeto()">Lanzar</button>
          </div>
        </div>
      </div>
    </div>






    <!-- #region tabs -->
    <div class="tab-content">
      <div id="home" class="tab-pane fade in active">
        <!-- <input class="form-control" type="text" value="Personaje" id="nombre">
        <button onclick="cargarPersonaje()"> Cargar personaje</button> -->
        <table class="table table-hover">
          <thead>
            <!-- <th>Característica</th>
            <th>Valor</th>
            <th>Bonificación</th>
            <th>Valor</th> -->
          </thead>
          <tbody id="statsTable"></tbody>
        </table>
        <form>
          <div class="input-group mb-3">
            <div class="input-group-prepend">
              <span class="input-group-text">PG</span>
              <input id="iPG" type="number" class="form-control number-input">
              <button id="btPG" class="btn btn-light" onclick="pMax(PG)" type="button">PGMAX</button>
            </div>
            <div class="number-input"></div>
            <div class="input-group-prepend">
              <span class="input-group-text">PF</span>
              <input id="iPF" type="number" class="form-control number-input">
              <button id="btPF" class="btn btn-light" onclick="pMax(PF)" type="button">PFMAX</button>
            </div>
            <div class="number-input"></div>
            <div class="input-group-prepend">
              <span class="input-group-text">PM</span>
              <input id="iPM" type="number" class="form-control number-input">
              <button id="btPM" class="btn btn-light" onclick="pMax(PM)" type="button">PMMAX</button>
            </div>
          </div>
        </form>

      </div>
      <div id="habilidades" class="tab-pane fade">
        <p>Busca en cualquier campo:</p>
        <input class="form-control" id="buscar" type="text" placeholder="Buscar..">
        <br>
        <select class="selectpicker" id="columnas" multiple data-live-search="true" data-width="fit" multiple
          title="Seleccione columnas a mostrar">
          <option selected>nombre</option>
          <option>xp</option>
          <option>tipo</option>
          <option>valor</option>
        </select>
        <table class="table table-hover">
          <thead id="header">
            <!-- <th>Habilidad</th>
            <th>Tipo</th>
            <th>Valor</th> -->
          </thead>
          <tbody id="tbHab"></tbody>
        </table>
      </div>
      <div id="inventario" class="tab-pane fade">
        <h3>Inventario</h3>
        <button type="button" class="btn btn-primary" onclick="atras()"> <i class="fas fa-arrow-left"></i>
          Atras</button>
        <p>Busca en cualquier campo:</p>
        <input class="form-control" id="buscarObjeto" type="text" placeholder="Buscar..">
        <br>
        <select class="selectpicker" id="colInventario" multiple data-live-search="true" data-width="fit" multiple
          title="Seleccione columnas a mostrar">
          <option selected>nombre</option>
          <option selected>peso</option>
          <option>ctd</option>
          <option>valor</option>
          <option>daño</option>
          <option>pesa()</option>
        </select>
        <button type="button" class="btn btn-danger" onclick="editar(new Objeto()) ;$('#editModal').modal();">Nuevo
          Objeto</button>
        <button type="button" class="btn btn-primary" onclick="editar(new Contenedor()); $('#editModal').modal();"> <i
            class="fas fa-box-open"></i>Nuevo Contenedor</button>
        <button type="button" class="btn btn-dark" onclick="copiar()"> <i class="fas fa-copy"></i> </button>
        <button type="button" class="btn btn-danger" onclick="cortar()"> <i class="fas fa-cut"></i></button>
        <button type="button" class="btn btn-primary" onclick="pegar()"><i class="fas fa-paste"></i></button>
        <table class="table table-hover">
          <thead id="hdInv">
            <!-- <th>Habilidad</th>
            <th>Tipo</th>
            <th>Valor</th> -->
          </thead>
          <tbody id="tbInv"></tbody>
        </table>
      </div>
      <div id="charts" class="tab-pane fade">
        <div>
          <!-- <canvas id="barChart"></canvas>
          <canvas id="radarChart"></canvas> -->
          <button class="btn btn-danger" onclick="lanzarHechizo()">Hechizo</button>

        </div>
      </div>
    </div>
    <!-- #endregion -->

    <p>Elige la fecha del Mundo</p>
    <input class="form-control" type="datetime-local" value="0177-07-07T00:00:01.0" id="fecha">
    <p id="texto"></p>

    <button onclick="act()"> Cambiar fecha y hora</button>
    <button onclick="saveStats()"> Guardar</button>

    <script>
      // el select guay
      $('select').selectpicker();

      var copiado = [];
      var nav = [];

      // $('#columnas').on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {
      //   // do something...
      //   // console.log($('#columnas').val());
      // });

      //buscar en habilidades
      //Buscar en la tabla
      $("#buscar").on("keyup", function () {

        var value = $(this).val().toLowerCase();
        //si empieza con > o <
        if (value.startsWith(">") || value.startsWith("<")) {
          var limit = parseInt(value.substring(1));
          var signo = value[0];
          console.log("SIGNO;" + signo);

          $("#tbHab tr").filter(function () {
            var bool = false
            console.log($(this).html());
            var regex = /[0-9]+/g; //la expresion regular para encontrar números en el html de la fila
            var found = $(this).html().match(regex);
            for (let i of found) { //por cada numero encontrado si cumple bool = true
              // console.log(parseInt(i)+":" +value.substring(1)); 
              // if(parseInt(i)>limit){
              if (eval('parseInt(i)' + signo + 'limit')) {
                bool = true;
                break;
              }
            }
            $(this).toggle(bool)
            // else
            // $(this).toggle(false);

          });
        }
        else //si no empieza con comparacion
          $("#tbHab tr").filter(function () {
            $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
          });
      });

      //buscar en el inventario
      $("#buscarObjeto").on("keyup", function () {

        var value = $(this).val().toLowerCase();
        //si empieza con > o <
        if (value.startsWith(">") || value.startsWith("<")) {
          var limit = parseInt(value.substring(1));
          var signo = value[0];
          console.log("SIGNO;" + signo);

          $("#tbInv tr").filter(function () {
            var bool = false
            console.log($(this).html());
            var regex = /[0-9]+/g; //la expresion regular para encontrar números en el html de la fila
            var found = $(this).html().match(regex);
            for (let i of found) { //por cada numero encontrado si cumple la condición, bool = true
              if (eval('parseInt(i)' + signo + 'limit')) {
                bool = true;
                break;
              }
            }
            $(this).toggle(bool)
          });
        }
        else //si no empieza con comparacion
          $("#tbInv tr").filter(function () {
            $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)//que contenga la cadena
          });
      });


      // if( /Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent) ) {
      //   $('.selectpicker').selectpicker('mobile');
      // }


      //cargar las habilidades
      //TODO: quitar esto??
      // for (habilidad in pj.habilidades) {
      //   console.log("Cargando las habilidades");

      //   var hh = new Habilidad();
      //   hh.setAll(habilidad);
      //   var row = $('#columnas');
      //   let habilidad = pj.getHabilidad(habilidad);

      //   for (key of habilidad) {//Esto serían todas
      //     row.append($("<option/>").text(habilidad[key]));
      //     console.log(habilidad[key]);
      //   }
      //   row.append($("<td/>").text(habilidad.v));
      //   console.log((row));
      // }

      // BOTONES DE PUNTOS

      function actPuntos() {
        $("#btPG").text("/  " + pj.getMaxPuntos(PG));
        $("#btPF").text("/  " + pj.getMaxPuntos(PF));
        $("#btPM").text("/  " + pj.getMaxPuntos(PM));

        $("#iPG").val(pj.getCar(PG));
        $("#iPF").val(pj.getCar(PF));
        $("#iPM").val(pj.getCar(PM));

      }


      function pMax(puntos) {
        valor = pj.getMaxPuntos(puntos);
        $("#i" + puntos).val(valor);
      }


      //Poblar con datos
      function tablaStats(idTabla = "statsTable") {
        var table = document.getElementById(idTabla);
        clear();

        for (let i in CP) {
          var row = table.insertRow();
          var tipo = row.insertCell(0);
          var cell = row.insertCell(1);
          let hTipo = row.insertCell(2);
          let hValor = row.insertCell(3);

          tipo.innerHTML = '<i data-toggle="tooltip"  id="lb' + CP[i] + '" title=' + CP[i] + '>' + CP[i] + '</i>';
          cell.innerHTML = '<i data-toggle="tooltip" contenteditable="true"  id="' + CP[i] + '" title=' + pj[CP[i]] + '>' + pj.getCar(CP[i]) + '</i>';
          hTipo.innerHTML = '<i data-toggle="tooltip"  id="' + TipoHabilidades[i] + '" title=' + TipoHabilidades[i] + '>' + TipoHabilidades[i] + '</i>';
          hValor.innerHTML = '<i data-toggle="tooltip"  id="' + pj.getCar(TipoHabilidades[i]) + '" title=' + pj[TipoHabilidades[i]] + '>' + pj.getCar(TipoHabilidades[i]) + '</i>';

        }
      }


      function tablaHabilidades() {
        var visibles = $("#columnas").val();
        // visibles.push(v);
        clear("tbHab");
        for (habilidad in pj.habilidades) {
          let hab = pj.getHabilidad(habilidad);
          objetoTabla(hab, "tbHab", visibles)
        };
      }
      //haccerlo de otra forma
      // function makeTable(container, pj = pj) {
      //   // var visibles = [
      //   //   "nombre",
      //   //   "tipo",
      //   //   "valor"
      //   // ]
      //   var visibles = $("#columnas").val();
      //   //creo que las cabeceras de las columnas
      //   createHeader(visibles);
      //   var table = $("<table/>").addClass("table table-hover");
      //   table = $("#tbHab");
      //   clear("tbHab");
      //   for (habilidad in pj.habilidades) {
      //     var hh = new Habilidad();
      //     hh.setAll(habilidad);
      //     var row = $("<tr/>");
      //     var habilidad = pj.getHabilidad(habilidad);

      //     for (key of visibles) {//Esto serían todas
      //       row.append($("<td/>").text(habilidad[key]));
      //       console.log(habilidad[key]);
      //     }
      //     row.append($("<td/>").html("<b>" + habilidad.v + "</b>"));
      //     table.append(row);
      //   }
      //   // return container.append(table);
      // }

      function createHeader(visibles, header = "header") {
        var th = document.getElementById(header);
        th.innerHTML = ""; //clear header
        var row = th.insertRow(0);
        for (var i in visibles) {
          var cell = row.insertCell(i);
          cell.innerHTML = '<b>' + visibles[i] + '</b>';
        }
        if (header === "header") {//si es habilidades
          // El total si sale siempre cambiar cuando se aplique tb a inventario
          // a no ser que ponga el peso total
          cell = row.insertCell();
          cell.innerHTML = '<b>' + "TOTAL" + '</b>';
          th.appendChild(row);
        }

      }



      function crearEventos(object, cell, key) {
        //si e sun contenedor cargo lso elementos que contiene
        if (object instanceof Contenedor) {

          if (key === "nombre") {
            // cell.style.color = "red";
            // cell.innerHTML += `   <button type="button" class="btn btn-secondary btn-sm" onclick="editar();" >Abrir</button>`
            cell.innerHTML += ` <span class="badge badge-dark">${object.objetos.length}</span>`

            cell.addEventListener("click", function () {
              let nc = object.nombre;
              let index = contenedorActual.objetos.indexOf(object);
              nav.push(index);
              console.log(nav);
              cargarContenedor(object);
              // editar(object);

            });
          }
        }
        if (object instanceof Objeto) {
          cell.addEventListener("dblclick", function () {
            // alert("mover objeto") + object.nombre;
            //modifico el editor modal
            editar(object);
            //y lo muestro
            $("#editModal").modal();
          });

        }
        if (object instanceof Habilidad) {
          if (key === "xp") { //si doy un click en xp +1
            cell.addEventListener("click", function () {
              //lo incremento y guardo en firebase 
              // object.xp++;
              object.addXP(1);
              object.save();
            });
          }

          if (key === "nombre") {
            cell.addEventListener("click", function () {
              //modifico el editor modal
              editar(object);
              //y lo muestro
              $("#editModal").modal();
            });

          }
        }
        // else
        //   cell.addEventListener("click", function () {
        //     console.log(object);
        //   });

      }

      //TODO: editar los objetos con el modal

      function editar(objeto) {
        // console.log("Editar:"+objeto );
        objetoActual = objeto;
        const keys = Object.keys(objeto);
        const values = Object.values(objeto);

        var editor = document.getElementById("editor");
        editor.innerHTML = ""; //clear editor
        var id = -1;
        var k = -1
        var v = -1;
        for (i = 0; i < keys.length; i++) {
          if (i == 0) id = values[i];
          k = keys[i];
          v = values[i];

          editor.innerHTML = editor.innerHTML + ' <b>' + k.toUpperCase() + ':</b>' +
            '<input data-toggle="tooltip"  id="edit' + keys[i] + '" value=' + values[i] + ' title=' + keys[i] + ' ><br>';
          //Probar con forms

        }
        editor.innerHTML = editor.innerHTML + `<button type="button" class="btn btn-success" onclick="guardarObjeto()">Guardar</button>`

      }

      function nuevoObjeto() {
        const keys = Object.keys(objetoActual);
        var values = Object.values(objetoActual);
        let nuevoObjeto = new objetoActual.constructor();

        console.log("Nuevo objeto:" + nuevoObjeto.constructor.name);
        //guardo los valores editados en el objeto
        for (i = 0; i < keys.length; i++) {
          var valor = $('#edit' + keys[i]).val();
          if (isNumber(valor)) values[i] = +valor;
          else values[i] = valor;
          nuevoObjeto[keys[i]] = values[i];
        }
        contenedorActual.add(nuevoObjeto);
        console.log(nuevoObjeto);
        console.log("en contenedor");
        console.log(contenedorActual);
        try {
          nuevoObjeto.save();
        } catch (error) {
          console.log(`El objeto ${nuevoObjeto.nombre} no se puede guardar`);
          console.log(pj);
          console.log(contenedorActual);
          pj.save();//guardo el personaje entero
          cargarPersonaje();
          // alert();
        }

      }

      function quitarObjeto() {
        if (objetoActual instanceof Objeto) {
          contenedorActual.sacar(objetoActual);
          try {
            console.log(`Quito ${objetoActual.nombre} de ${contenedorActual.nombre}`);
            pj.save();//guardo
            cargarPersonaje();
          } catch (error) {
            console.log(`Error al quitar ${objetoActual.nombre} de ${contenedorActual.nombre}`);
            // alert();
          }
        }

      }

      function guardarObjeto() {

        const keys = Object.keys(objetoActual);
        var values = Object.values(objetoActual);

        console.log("Editar objeto:");
        //guardo los valores editados en el objeto
        for (i = 0; i < keys.length; i++) {
          var valor = $('#edit' + keys[i]).val();
          if (isNumber(valor)) values[i] = +valor;
          else values[i] = valor;
          objetoActual[keys[i]] = values[i];
        }
        console.log(objetoActual);
        var id = values[0]; //Imaginamos que el id es el 1er campo
        try {
          objetoActual.save();
        } catch (error) {
          console.log(`El objeto ${objetoActual.nombre} no se puede guardar`);
          console.log(pj);
          pj.save();

          if (contenedorActual) {
            console.log(contenedorActual);
            cargarContenedor(contenedorActual);
          }
          else
            cargaInventario(pj);



          // alert();
        }

      }

      function isNumber(value) {
        if (value instanceof Number)
          return true
        else
          return !isNaN(value);
      }


      function saveStats() {
        for (let i in CP) {
          var x = parseInt(document.getElementById(CP[i]).innerHTML);
          // var x = eval(document.getElementById(CP[i]).innerHTML);
          console.log(x);
          pj[CP[i]] = x;
        }
        pj.nombre = $("#nombre").val();
        pj.act();
        tablaStats();
        pj.backup = null; //para que no se vuelva a cargar con los efectos.

        pj.save();

        // var h1 = new Habilidad("AAAA", "Agilidad", 7);
        // console.log(h1);
        // // h1.save();
        // pj.setHabilidad(h1);

        // var h1 = new Habilidad("Correr", "Agilidad", 100);
        // var b1 = new BonHabilidad("Correr", 0, 10, 10);
        // h1.activarBon(b1);

        // pj.setHabilidad(h1);
        // pj.setHabilidad(new Habilidad("Trepar", "Agilidad", 15));
        // pj.setHabilidad(new Habilidad("Saltar", "Agilidad", 30));
        // pj.setHabilidad(new Habilidad("Esquivar", "Agilidad", 25));

        console.log(pj);

        // makeTable($("#habilidades"), pj);

        // efFuerza = new Efecto("fuerza", `this.sb(FUE,"+5")`, fechaMundo.add("dia", 4));
        // efDes = new Efecto("des", `this.DES+=5`, fechaMundo.add("dia", 4));
        // efTam = new Efecto("tamaño", `this.sb(TAM,5)`, fechaMundo.add("dia", 4));
        // efAsp = new Efecto("aspecto", `this.ASP=18`, fechaMundo.add("dia", 4));
        // efReflex = new Efecto("Reflejos felinos", `this.DES+=5; this.sb(Agilidad,'+5') `, fechaMundo.add("dia", 4));
        // efPermanente = new Efecto("Permanente", `this.ASP+=5; this.sb(Comunicación,'+5') `);


        // pj.addEfecto(efFuerza)
        // pj.addEfecto(efDes)
        // pj.addEfecto(efTam)
        // pj.addEfecto(efAsp)
        // pj.addEfecto(efReflex)
        // pj.addEfecto(efPermanente)

        // pj.aplicarEfectos()
        // pj.nombre = "Copia";
        // pj.save();

      }

      function clear(id = "statsTable") {
        var tb = document.getElementById(id);
        tb.innerHTML = ""; //clear body
      }

      function act() {
        var x = document.getElementById("fecha").value;
        document.getElementById("texto").innerHTML = x;
        // console.log("fechaMundo x :"+x);
        fechaMundo = new Date(x + ".000Z");
        // console.log("fechaMundo:"+fechaMundo.toISOString());
        document.getElementById("texto").innerHTML = pj.aplicarEfectos()
        pj.act();
        tablaStats();

      }
      function lanzarHechizo(hechizo) {

        let h = new Hechizo("Hechizo", 7, 100, null);
        const porcentajeInicial = h.valor;
        $("#modalHechizo").modal();
        intensidad = pj.getHabilidad("Intensidad");
        pIntensidad = intensidad.v;
        let pm = $("#iPMIntensidad").val();
        let penalizacion = 0;
        let ipm;
        let tHechizo, tIntensidad, tDuración = TipoTirada.EXITO;
        let pmIntensidad, pmDuración = 0;
        let intensidadReal;

        ipm = //$("#iPMIntensidad");
          document.getElementById("iPMIntensidad");

        dIntensidad = document.getElementById("iDadosIntensidad");
        dHechizo = document.getElementById("iDadosHechizo");


        function act() {
          //% de habilidad
          switch (tIntensidad) {
            case (SUPERCRITICO):
              intensidadReal = ipm.value + 5;
              pmIntensidad = 1;
              penalizacion = 0;
              dIntensidad.style.color = "red";
              break;
            case (CRITICO):
              intensidadReal = ipm.value + 3;
              pmIntensidad = 1;
              penalizacion = 0;
              dIntensidad.style.color = "red";
              break;
            case (ESPECIAL):
              intensidadReal = ipm.value + 1;
              pmIntensidad = pm;
              penalizacion = 0;
              dIntensidad.style.color = "blue";
              break;
            case (EXITO):
              intensidadReal = pm;
              pmIntensidad = pm;
              dIntensidad.style.color = "black";
              break;
            case (FALLO):
              intensidadReal = 0;
              pmIntensidad = 1;
              break;
            default:
              ;
          }


          switch (tHechizo) {
            case (SUPERCRITICO):
              pmHechizo = 1;
              dHechizo.style.color = "red";
              break;
            case (CRITICO):
              pmHechizo = 1;
              dHechizo.style.color = "red";
              break;
            case (ESPECIAL):
              pmHechizo = h.pm;
              dHechizo.style.color = "blue";
              break;
            case (EXITO):

              pmHechizo = h.pm;
              dHechizo.style.color = "black";
              break;
            case (FALLO):
              pmHechizo = 1;
              break;
            default:
              ;
          }


          //TODO: soporte para -1,etc en tiradas?
          // switch (true) {
          //   case (tIntensidad == SUPERCRITICO):
          //     intensidadReal = ipm.value + 5;
          //     pmIntensidad = 1;
          //     penalizacion = 0;
          //     break;
          //   case (tIntensidad == CRITICO):
          //     intensidadReal = ipm.value + 3;
          //     pmIntensidad = 1;
          //     penalizacion = 0;
          //     break;
          //   case (tIntensidad  ==ESPECIAL):
          //     intensidadReal = ipm.value + 1;
          //     pmIntensidad = pm;
          //     penalizacion = 0;
          //   break;
          //   case (tIntensidad == EXITO):
          //     intensidadReal= pm;
          //   pmIntensidad = pm;
          //     break;
          //   case (tIntensidad > this.v):
          //     return TipoTirada.FALLO;
          //   default:
          //     ;
          // }


          // if (tIntensidad > ESPECIAL) {
          //   pmIntensidad = 1;
          //   penalizacion = 0;

          // } else
          // if (tIntensidad == ESPECIAL) {
          //     pmIntensidad = pm;
          //     penalizacion = 0;
          //   } else
          //   if (tIntensidad == EXITO) {
          //     pmIntensidad = pm;
          //   } else {
          //     pmIntensidad = 1; //FALLO
          //   }


          // if (tHechizo > ESPECIAL) {
          //   pmHechizo = 1;
          //   penalizacion = 0;

          // } else
          // if (tHechizo == EXITO) {
          //     pmHechizo = h.pm;
          //   } else

          //   if (tHechizo > EXITO) {
          //     pmHechizo = h.pm;
          //   } else {
          //     pmHechizo = 1; //FALLO
          //   }



          h.valor = porcentajeInicial - penalizacion;

          console.log(`Intensidad: ${tIntensidad}, Hechizo: ${tHechizo}`);

          $("#lbHechizo").text(`Hechizo: ${h.v}%`);
          $("#iGastados").val(parseInt(pmIntensidad) + pmHechizo);

        }



        function cambiaIntensidad() {

          pm = $("#iPMIntensidad").val();
          //TODO: hacerlo con bonificación de verdad BonHabilidad
          penalizacion = pm * 5;
          act();
        }

        ipm.addEventListener("change", cambiaIntensidad);

        dIntensidad.addEventListener("change", function () {
          tIntensidad = intensidad.tirada(dIntensidad.value);
          console.log("Intensidad" + (tIntensidad));
          //TODO: hacerlo con bonificación de verdad BonHabilidad
          penalizacion = pm * 5;
          act();
        });

        dHechizo.addEventListener("change", function () {
          tHechizo = h.tirada(dHechizo.value);
          console.log("Hechizo" + (tHechizo));
          //TODO: hacerlo con bonificación de verdad BonHabilidad
          act();
        });




        $("#lbIntensidad").text(`Intensidad: ${pIntensidad}%`);

        // $("#btPM").text("/  " + pj.getMaxPuntos(PM));

        // $("#iPG").val(pj.getCar(PG));
        // $("#iPF").val(pj.getCar(PF));
        // $("#iPM").val(pj.getCar(PM));
      }

      function atras() {
        nav.pop();
        ir();
      }
      function ir() {

        console.log("CARGA CONTENEDOR");
        console.log(pj.inventario.navegar(nav).nombre);
        cargarContenedor(pj.inventario.navegar(nav));

      }
      function copiar() {
        copiado.push(objetoActual);
        console.log(copiado);
      }

      function cortar() {
        copiado.push(objetoActual);
        contenedorActual.sacar(objetoActual);
        pj.save();
        // cargarPersonaje(true);

      }

      function pegar() {
        copiado.forEach(element => {
          if (element instanceof Objeto) {
            contenedorActual.add(element);
          }
        });
        copiado = [];
        pj.save()
        // cargarPersonaje(true);

      }


      //las funciones de rol.js

      function cargar(ruta) {
        console.log("CARGAR RUTA:" + ruta);
        fbActual = database.ref(ruta);
        //si lo hago así es menos eficiente porque siempre que haya un cambio
        //carga todas las habilidades

        //por si quiero ordenar de algún modo: .orderByChild("valor").on(...

        fbActual.on('value', function (item) {
          clear("tbHab");
          //this is saying foreach order do the following function...
          item.forEach(function (firebaseReference) {
            a = firebaseReference.val();
            var nh = new Habilidad();
            nh.setAll(a);
            pj.setHabilidad(nh);
            // console.log(a); //check your console to see it!
            // addObjet2Table(nh,"tbHab");
          });
          //TODO: poner aquí el header??
          // makeTable("", pj);
        });

        // Get the hab that has changed

        // fbActual.on("child_changed", function (snapshot) {
        //   var changedHab = snapshot.val();
        //     var nh = new Habilidad();
        //     nh.setAll(changedHab);
        //     pj.setHabilidad(nh);
        //   console.log("Nodo cambiado");
        //   console.log(changedHab);
        //   makeTable("", pj);
        // });

        //Tal vez debería hacerlo para added y removed

        // $('#myTable').css('textTransform', 'capitalize');
      }


      // function cargarRuta() {
      //   cargar($("#rutas").val());
      // }
      function cargarHabilidad(personaje = pj) {
        cargar(`personajes/${personaje.nombre}/habilidades/`);
      }

      function cargaInventario(pj) {
        console.log("Carga Inventario");
        nav = [];
        cargarContenedor(pj.inventario);
      }

      function cargarContenedor(object) {
        if (!(object instanceof Contenedor)) return; //si no es contenedor
        //hago éste el contenedor actual
        contenedorActual = object;
        console.log("Contenedor Act:");
        console.log(contenedorActual);
        clear("tbInv"); //limpio la tabla
        let visibles = $("#colInventario").val();
        createHeader(visibles, "hdInv");
        object.objetos.forEach(function (element) {
          // addObjet2Table(element, "tbInv")
          objetoTabla(element, "tbInv", visibles);
        });
        addObjet2Table(["peso Total", roundTo3(object.pesa())], "tbInv")
      }

      function roundTo3(num) {
        //redondeamos a gramos  
        return +(Math.round(num + "e+3") + "e-3");
      }

      function cargarPersonaje(nombre) {
        if (nombre == true) {
          contenedorActual = null; //Llamo desde el boton y voy al inventario general
        }

        nombre = $("#nombre").val();
        let ruta = `personajes/${nombre}/`;
        // console.log("CARGAR RUTA:" + ruta);
        fbActual = database.ref(ruta);

        // si lo hago así es menos eficiente,
        // porque siempre que haya un cambio
        // donde sea me, va a cargar el personaje entero
        fbActual.on('value', function (item) {
          console.log("onvalue personaje" + item.val().nombre);
          pj = new Animal({});
          pj.setAll(item.val());

          console.log("CARGA EL PUTO PERSONAJE:" + pj.nombre);
          // console.log(pj);
          document.title = pj.nombre;

          // makeTable("", pj);
          tablaHabilidades();
          tablaStats();
          actPuntos();

          //Inventario nuevo TODO: quitar
          // pj.inventario = creaInventario();
          // console.log(pj.inventario.darContenedores());
          // console.log("ARMAS");
          // console.log(pj.inventario.darClase(Arma));
          // console.log("Objetos");
          // console.log(pj.inventario.darClase(Objetos));


          //TODO: hacer que funcione
          if (contenedorActual) {
            console.log("Contenedor Act:");
            console.log(contenedorActual);
            cargarContenedor(contenedorActual);
          }
          else
            cargaInventario(pj);
          nav = [];
          // console.log("No ContenedorAct: CargaInventario");
        });

        //  podría hacerlo con once y luego responder a cambios en habilidades,
        //  en inventario y en las características

        // fbActual.once("value", function (data) {
        //    pj = new Animal({});
        //    pj.setAll(item.val());
        //    // mostrar las demás: makeTable("", pj), etc
        // });

        // fbActual.on("child_changed", function (snapshot) {
        //   var changedPost = snapshot.val();
        //   console.log("The updated post title is " + changedPost.title);
        // });

        // Mover un objeto
        //  pj.inventario.mover(1, a.inventario);
        //  console.log(pj);
        //  console.log(a);
        //  pj.save();
        //  a.save();

      }


      // var lastObject={};

      function addObjet2Table(object, tabla) {

        const keys = Object.keys(object);
        // const lastKeys = Object.keys(lastObject);
        // lastObject= object;

        const values = Object.values(object);

        var table = document.getElementById(tabla);
        var row = table.insertRow();

        // if(JSON.stringify(keys)==JSON.stringify(lastKeys)) console.log("Misma fila");
        // // if(keys.length==lastKeys.length) console.log("Misma fila");
        // else  createHeader(keys, "hdInv") //console.log("Fila distinta:"+ lastKeys +"<->"+ keys);

        var id = -1
        for (i = 0; i < keys.length; i++) {
          if (i == 0) id = values[i];
          // var k = keys[i];
          // var v = values[i];
          var cell = row.insertCell(i);
          crearEventos(object, cell);

          cell.innerHTML = '<i data-toggle="tooltip"  id="' + id + "|" + keys[i] + "|" + values[i] + '" title=' + keys[i] + '>' + values[i] + '</i>';
          // cell.tooltip({title: "<h1><strong>HTML</strong> $keys[i] <code>the</code> <em>tooltip</em></h1>", html: true, placement: "bottom"});
          // console.log(keys[i] + ":" + values[i]); //check your console to see it!
        }

      }

      function objetoTabla(object, tabla, visibles) {
        var table = document.getElementById(tabla);
        var row = table.insertRow();

        var i = 0
        for (key of visibles) {//Esto serían todas
          var cell = row.insertCell(i);
          let valor;
          if (key.includes("()")) {//si es un método
            valor = eval("object." + key);
          }
          else {
            if (i == 0) id = object[key];
            // crearEventos(object, cell, key);
            // console.log(object[key]);
            valor = object[key];
          }

          if (valor === undefined) valor = "";
          cell.innerHTML = '<i data-toggle="tooltip"  id="' + id + "|" + key + "|" + valor + '" title=' + key + '>' + valor + '</i>';
          crearEventos(object, cell, key);
          i++;
        }

        if (object instanceof Habilidad) { var cell = row.insertCell(i); cell.innerHTML = "<b>" + object.v + "</b>" }

      }

    </script>

</body>

</html>